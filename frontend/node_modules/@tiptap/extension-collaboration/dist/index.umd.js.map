{"version":3,"file":"index.umd.js","sources":["../src/collaboration.ts","../src/helpers/isChangeOrigin.ts"],"sourcesContent":["import { Extension } from '@tiptap/core'\nimport { EditorView } from '@tiptap/pm/view'\nimport {\n  redo,\n  undo,\n  ySyncPlugin,\n  yUndoPlugin,\n  yUndoPluginKey,\n} from 'y-prosemirror'\nimport { UndoManager } from 'yjs'\n\ntype YSyncOpts = Parameters<typeof ySyncPlugin>[1]\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    collaboration: {\n      /**\n       * Undo recent changes\n       */\n      undo: () => ReturnType,\n      /**\n       * Reapply reverted changes\n       */\n      redo: () => ReturnType,\n    }\n  }\n}\n\nexport interface CollaborationOptions {\n  /**\n   * An initialized Y.js document.\n   */\n  document: any,\n  /**\n   * Name of a Y.js fragment, can be changed to sync multiple fields with one Y.js document.\n   */\n  field: string,\n  /**\n   * A raw Y.js fragment, can be used instead of `document` and `field`.\n   */\n  fragment: any,\n  /**\n   * Fired when the content from Yjs is initially rendered to Tiptap.\n   */\n  onFirstRender?: () => void,\n\n  ySyncOptions?: YSyncOpts\n}\n\nexport const Collaboration = Extension.create<CollaborationOptions>({\n  name: 'collaboration',\n\n  priority: 1000,\n\n  addOptions() {\n    return {\n      document: null,\n      field: 'default',\n      fragment: null,\n    }\n  },\n\n  onCreate() {\n    if (this.editor.extensionManager.extensions.find(extension => extension.name === 'history')) {\n      console.warn('[tiptap warn]: \"@tiptap/extension-collaboration\" comes with its own history support and is not compatible with \"@tiptap/extension-history\".')\n    }\n  },\n\n  addCommands() {\n    return {\n      undo: () => ({ tr, state, dispatch }) => {\n        tr.setMeta('preventDispatch', true)\n\n        const undoManager: UndoManager = yUndoPluginKey.getState(state).undoManager\n\n        if (undoManager.undoStack.length === 0) {\n          return false\n        }\n\n        if (!dispatch) {\n          return true\n        }\n\n        return undo(state)\n      },\n      redo: () => ({ tr, state, dispatch }) => {\n        tr.setMeta('preventDispatch', true)\n\n        const undoManager: UndoManager = yUndoPluginKey.getState(state).undoManager\n\n        if (undoManager.redoStack.length === 0) {\n          return false\n        }\n\n        if (!dispatch) {\n          return true\n        }\n\n        return redo(state)\n      },\n    }\n  },\n\n  addKeyboardShortcuts() {\n    return {\n      'Mod-z': () => this.editor.commands.undo(),\n      'Mod-y': () => this.editor.commands.redo(),\n      'Shift-Mod-z': () => this.editor.commands.redo(),\n    }\n  },\n\n  addProseMirrorPlugins() {\n    const fragment = this.options.fragment\n      ? this.options.fragment\n      : this.options.document.getXmlFragment(this.options.field)\n\n    // Quick fix until there is an official implementation (thanks to @hamflx).\n    // See https://github.com/yjs/y-prosemirror/issues/114 and https://github.com/yjs/y-prosemirror/issues/102\n    const yUndoPluginInstance = yUndoPlugin()\n    const originalUndoPluginView = yUndoPluginInstance.spec.view\n\n    yUndoPluginInstance.spec.view = (view: EditorView) => {\n      const { undoManager } = yUndoPluginKey.getState(view.state)\n\n      if (undoManager.restore) {\n        undoManager.restore()\n        // eslint-disable-next-line\n        undoManager.restore = () => {}\n      }\n\n      const viewRet = originalUndoPluginView ? originalUndoPluginView(view) : undefined\n\n      return {\n        destroy: () => {\n          const hasUndoManSelf = undoManager.trackedOrigins.has(undoManager)\n          // eslint-disable-next-line\n          const observers = undoManager._observers\n\n          undoManager.restore = () => {\n            if (hasUndoManSelf) {\n              undoManager.trackedOrigins.add(undoManager)\n            }\n\n            undoManager.doc.on('afterTransaction', undoManager.afterTransactionHandler)\n            // eslint-disable-next-line\n            undoManager._observers = observers\n          }\n\n          if (viewRet?.destroy) {\n            viewRet.destroy()\n          }\n        },\n      }\n    }\n\n    const options = this.options.ySyncOptions\n    const onFirstRender = this.options.onFirstRender\n    const ySyncPluginOptions: YSyncOpts = {\n      ...(options ? { ...options } : {}),\n      ...(onFirstRender ? { onFirstRender } : {}),\n    }\n\n    const ySyncPluginInstance = ySyncPlugin(fragment, ySyncPluginOptions)\n\n    return [ySyncPluginInstance, yUndoPluginInstance]\n  },\n})\n","import { Transaction } from '@tiptap/pm/state'\nimport { ySyncPluginKey } from 'y-prosemirror'\n\nexport function isChangeOrigin(transaction: Transaction): boolean {\n  return !!transaction.getMeta(ySyncPluginKey)\n}\n"],"names":["Extension","yUndoPluginKey","undo","redo","yUndoPlugin","ySyncPlugin","ySyncPluginKey"],"mappings":"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"}